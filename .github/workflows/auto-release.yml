name: Auto Release

on:
  push:
    branches: [main]

jobs:
  bump-and-tag:
    # Skip our own release commits to prevent infinite loops.
    if: "!startsWith(github.event.head_commit.message, 'chore: release')"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # PAT is required so the tag push triggers release.yml.
          # Create a fine-grained PAT with "Contents: write" and store it
          # as a repository secret named RELEASE_PAT.
          token: ${{ secrets.RELEASE_PAT }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump patch version
        id: bump
        run: |
          # Read version from [workspace.package] in the root Cargo.toml.
          CURRENT=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "current=${CURRENT}" >> $GITHUB_OUTPUT
          echo "new=${NEW_VERSION}"  >> $GITHUB_OUTPUT
          echo "Bumping: ${CURRENT} → ${NEW_VERSION}"

          # Update the single source-of-truth version in root Cargo.toml.
          sed -i "s/^version = \"${CURRENT}\"/version = \"${NEW_VERSION}\"/" Cargo.toml

          # Update Cargo.lock entries for all openintent-* workspace members.
          # perl -0pe slurps the file and matches across lines.
          perl -i -0pe \
            "s/(\[\[package\]\]\nname = \"openintent-[^\"\n]+\"\nversion = \")${CURRENT}\"/$1${NEW_VERSION}\"/g" \
            Cargo.lock

          echo "Updated Cargo.toml and Cargo.lock"

      - name: Commit and tag
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new }}"
          git add Cargo.toml Cargo.lock
          git commit -m "chore: release v${NEW_VERSION}"
          git tag "v${NEW_VERSION}"
          # Push commit first, then tag — tag push triggers release.yml.
          git push origin main
          git push origin "v${NEW_VERSION}"
